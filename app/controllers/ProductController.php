<?php
require_once __DIR__.'/../lib/session.php';require_once __DIR__.'/../lib/auth.php';require_once __DIR__.'/../lib/db.php';require_once __DIR__.'/../lib/util.php';
function product_index(){require_login();$pdo=DB::pdo();$rows=$pdo->query('SELECT p.idproducto,p.nombre,p.precio,p.stock,COALESCE(c.nombre,"") AS categoria FROM producto p LEFT JOIN categoria c ON p.idcategoria=c.idcategoria ORDER BY p.idproducto DESC')->fetchAll();include __DIR__.'/../views/product_index.php';}
function product_save(){require_login();if($_SERVER['REQUEST_METHOD']!=='POST'){header('Location: index.php?r=product/index');exit;}$nombre=trim($_POST['nombre']??'');$precio=(float)($_POST['precio']??0);$stock=(int)($_POST['stock']??0);$categoria=trim($_POST['categoria']??'');if(!$nombre){$error='Nombre requerido';product_index();return;}$pdo=DB::pdo();$pdo->beginTransaction();try{$cat_id=null;if($categoria){$st=$pdo->prepare('SELECT idcategoria FROM categoria WHERE nombre=?');$st->execute([$categoria]);$cat_id=$st->fetchColumn();if(!$cat_id){$pdo->prepare('INSERT INTO categoria(nombre) VALUES (?)')->execute([$categoria]);$cat_id=$pdo->lastInsertId();}}$pdo->prepare('INSERT INTO producto(nombre,descripcion,precio,stock,idcategoria) VALUES (?,?,?,?,?)')->execute([$nombre,'',$precio,$stock,$cat_id]);$pdo->commit();}catch(Throwable $e){$pdo->rollBack();throw $e;}header('Location: index.php?r=product/index');}
function product_delete(){require_login();$id=(int)($_GET['id']??0);$pdo=DB::pdo();$st=$pdo->prepare('DELETE FROM producto WHERE idproducto=?');$st->execute([$id]);header('Location: index.php?r=product/index');}
